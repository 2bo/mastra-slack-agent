# =============================================================================
# Mastra MCP Server - AWS Lambda Dockerfile
# Uses Lambda Web Adapter to run Mastra's built-in Hono server on Lambda
# =============================================================================

FROM node:22-alpine AS builder

WORKDIR /app

COPY package.json pnpm-lock.yaml ./
RUN npm install -g pnpm && pnpm install --frozen-lockfile

COPY src ./src
COPY tsconfig.json ./

RUN npx mastra build

# -----------------------------------------------------------------------------
# Runtime stage
# -----------------------------------------------------------------------------
FROM node:22-alpine

WORKDIR /app

# gcompat is needed for some native modules on Alpine
RUN apk add --no-cache gcompat

# Lambda Web Adapter: translates Lambda invoke â†’ HTTP request
COPY --from=public.ecr.aws/awsguru/aws-lambda-adapter:0.9.0 /lambda-adapter /opt/extensions/lambda-adapter

# Copy built output (self-contained with its own node_modules)
COPY --from=builder /app/.mastra/output ./

RUN addgroup -g 1001 -S nodejs && \
    adduser -S mastra -u 1001 && \
    chown -R mastra:nodejs /app

USER mastra

ENV PORT=8080
ENV NODE_ENV=production
ENV READINESS_CHECK_PATH="/api"

EXPOSE 8080

CMD ["node", "index.mjs"]
